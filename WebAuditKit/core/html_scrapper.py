import httplib, re
from bs4 import BeautifulSoup


class html_scrapper:

    def __init__(self, host, port_list, working_dir, depth):
        self.host = host
        self.port_list = port_list
        self.working_dir = working_dir
        self.depth = depth
        self.fuzzing_dirs = list()
        self.start_scrapping()

    def start_scrapping(self):
        for port in self.port_list:
            if port[1] == '80' or port[1] == '443' and port[2] == 'up':
                self.analyze_html(port[1])

    def analyze_html(self, port):
        conn = httplib.HTTPConnection(self.host, port, timeout=10)
        conn.request('GET', '/')
        res = conn.getresponse()
        data = res.read()

        bs = BeautifulSoup(data, 'html.parser')
        scripts = bs.findAll('script', attrs={'src':True})
        target_dirs = list()
        for script in scripts:
            target_dirs.append(script['src'])

        self.get_fuzzing_dirs(target_dirs)


    def get_fuzzing_dirs(self, target_dirs):
        tmp_list = list()
        for target in target_dirs:
            tmp_list.append(re.findall(r'/(.*?)/', target))

        targets = list(set(map(tuple,tmp_list))) #List of lists
        self.fuzzing_dirs = self.tuple_to_strings(targets)

    def tuple_to_strings(self,tuples_list):
        strings_list = list()
        for tuple in tuples_list:
            i = 0
            path = '/'
            while i < len(tuple):
                path += tuple[i] + '/'
                i += 1
            strings_list.append(path)
        return strings_list